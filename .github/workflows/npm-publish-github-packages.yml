name: Publish package (pnpm → GitHub Packages)

on:
  release:
    types: [created]   # runs only when you create /publish/ a GitHub Release ⧉

concurrency:           # avoids two parallel releases for the same tag
  group: release-${{ github.ref }}
  cancel-in-progress: false

jobs:
  # ──────────────────────────────
  build-and-test:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4          # latest major for 2025  [oai_citation:0‡GitHub](https://github.com/actions/checkout?utm_source=chatgpt.com)

      # Node + dependency cache (built-in “pnpm” mode)
      - uses: actions/setup-node@v4
        with:
          node-version: 20                 # LTS in 2025
          cache: pnpm                      # one-line cache opt-in  [oai_citation:1‡GitHub](https://github.com/actions/setup-node?utm_source=chatgpt.com) [oai_citation:2‡The GitHub Blog](https://github.blog/changelog/2021-07-02-github-actions-setup-node-now-supports-dependency-caching/?utm_source=chatgpt.com)

      # Official pnpm installer (auto-runs pnpm install)
      - uses: pnpm/action-setup@v4         # current major  [oai_citation:3‡GitHub](https://github.com/pnpm/action-setup?utm_source=chatgpt.com)
        with:
          version: latest                  # pin if you need an older pnpm
          run_install: true                # == pnpm install

      - name: Unit tests
        run: pnpm test                     # adapt to your test script ⧉

  # ──────────────────────────────
  publish:
    needs: build-and-test
    runs-on: ubuntu-latest

    permissions:                           # required for GITHUB_TOKEN publish
      contents: read
      packages: write

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          registry-url: https://npm.pkg.github.com/  # writes an .npmrc + auth  [oai_citation:4‡GitHub Docs](https://docs.github.com/packages/working-with-a-github-packages-registry/working-with-the-npm-registry?utm_source=chatgpt.com)
          cache: pnpm

      - uses: pnpm/action-setup@v4
        with:
          version: latest
          run_install: true

      - name: Publish to GitHub Packages
        run: pnpm publish --no-git-checks --access public   # add flags as needed  [oai_citation:5‡pnpm](https://pnpm.io/cli/publish?utm_source=chatgpt.com)
        env:
          NODE_AUTH_TOKEN: ${{ secrets.GITHUB_TOKEN }}      # auto-scoped PAT
